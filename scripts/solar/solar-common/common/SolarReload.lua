local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__New = ____lualib.__TS__New
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["7"] = 1,["8"] = 1,["9"] = 2,["10"] = 2,["11"] = 3,["12"] = 3,["13"] = 4,["14"] = 4,["15"] = 5,["16"] = 5,["17"] = 6,["18"] = 6,["19"] = 8,["20"] = 8,["21"] = 9,["22"] = 9,["23"] = 10,["24"] = 10,["25"] = 12,["26"] = 12,["27"] = 12,["29"] = 12,["30"] = 34,["31"] = 35,["34"] = 38,["35"] = 39,["40"] = 57,["43"] = 43,["44"] = 45,["45"] = 47,["52"] = 60,["53"] = 61,["54"] = 62,["55"] = 63,["56"] = 63,["57"] = 63,["58"] = 64,["59"] = 64,["60"] = 64,["61"] = 65,["62"] = 66,["64"] = 64,["65"] = 64,["66"] = 69,["67"] = 63,["68"] = 63,["70"] = 74,["71"] = 75,["72"] = 77,["73"] = 78,["74"] = 81,["75"] = 81,["76"] = 81,["77"] = 81,["78"] = 81,["79"] = 81,["80"] = 81,["81"] = 82,["82"] = 82,["83"] = 82,["84"] = 83,["85"] = 84,["87"] = 86,["88"] = 82,["89"] = 82,["91"] = 89,["92"] = 90,["93"] = 34,["94"] = 93,["95"] = 94,["96"] = 95,["99"] = 98,["100"] = 99,["102"] = 101,["104"] = 103,["105"] = 103,["107"] = 103,["109"] = 103,["111"] = 103,["113"] = 103,["116"] = 104,["118"] = 106,["119"] = 107,["120"] = 108,["121"] = 108,["122"] = 108,["123"] = 108,["124"] = 108,["125"] = 108,["126"] = 108,["127"] = 109,["128"] = 93,["129"] = 112,["130"] = 113,["131"] = 114,["134"] = 120,["135"] = 121,["136"] = 122,["137"] = 123,["138"] = 124,["141"] = 128,["142"] = 129,["143"] = 130,["146"] = 133,["147"] = 134,["148"] = 135,["151"] = 138,["152"] = 139,["153"] = 140,["156"] = 143,["157"] = 144,["158"] = 145,["161"] = 149,["164"] = 147,["173"] = 154,["174"] = 155,["175"] = 156,["176"] = 157,["180"] = 163,["181"] = 112,["182"] = 167,["183"] = 169,["184"] = 170,["185"] = 171,["186"] = 172,["187"] = 172,["188"] = 174,["189"] = 175,["190"] = 176,["191"] = 177,["193"] = 179,["194"] = 180,["195"] = 180,["197"] = 182,["198"] = 170,["199"] = 185,["200"] = 186,["201"] = 187,["202"] = 188,["203"] = 188,["204"] = 190,["205"] = 191,["206"] = 192,["207"] = 193,["209"] = 195,["210"] = 196,["211"] = 196,["213"] = 198,["214"] = 186,["215"] = 201,["216"] = 202,["217"] = 203,["218"] = 203,["219"] = 203,["220"] = 203,["221"] = 203,["222"] = 203,["223"] = 203,["224"] = 204,["225"] = 204,["226"] = 206,["227"] = 207,["228"] = 208,["229"] = 209,["231"] = 211,["232"] = 212,["233"] = 212,["235"] = 214,["236"] = 202,["237"] = 217,["238"] = 218,["239"] = 219,["240"] = 219,["241"] = 219,["242"] = 219,["243"] = 219,["244"] = 219,["245"] = 219,["246"] = 220,["247"] = 220,["248"] = 222,["249"] = 223,["250"] = 224,["251"] = 225,["253"] = 227,["254"] = 228,["255"] = 228,["257"] = 230,["258"] = 218,["259"] = 233,["260"] = 234,["261"] = 235,["262"] = 236,["263"] = 236,["264"] = 238,["265"] = 239,["266"] = 240,["267"] = 241,["269"] = 243,["270"] = 244,["271"] = 244,["273"] = 246,["274"] = 234,["275"] = 249,["276"] = 250,["277"] = 251,["278"] = 252,["280"] = 254,["282"] = 256,["283"] = 257,["284"] = 258,["287"] = 262,["288"] = 263,["289"] = 264,["290"] = 265,["291"] = 249,["292"] = 267,["293"] = 269,["294"] = 270,["295"] = 271,["296"] = 272,["298"] = 274,["299"] = 275,["300"] = 275,["302"] = 267,["303"] = 167,["304"] = 280,["305"] = 281,["306"] = 282,["309"] = 284,["312"] = 287,["313"] = 288,["314"] = 289,["315"] = 290,["316"] = 291,["319"] = 293,["322"] = 296,["323"] = 297,["324"] = 298,["325"] = 299,["326"] = 300,["327"] = 301,["328"] = 302,["331"] = 290,["332"] = 280,["333"] = 308,["334"] = 309,["335"] = 310,["336"] = 311,["337"] = 311,["338"] = 311,["339"] = 311,["340"] = 311,["341"] = 311,["342"] = 311,["343"] = 312,["344"] = 314,["346"] = 316,["347"] = 317,["349"] = 319,["353"] = 321,["354"] = 322,["355"] = 323,["356"] = 324,["357"] = 326,["358"] = 327,["359"] = 328,["360"] = 329,["362"] = 331,["363"] = 332,["365"] = 334,["366"] = 335,["368"] = 337,["369"] = 338,["371"] = 340,["372"] = 341,["375"] = 345,["378"] = 343,["386"] = 349,["387"] = 350,["388"] = 351,["389"] = 352,["390"] = 308,["391"] = 13,["392"] = 14,["393"] = 15,["394"] = 16,["395"] = 17,["396"] = 18,["397"] = 28,["398"] = 31});
local ____exports = {}
local ____trigger = require("solar.solar-common.w3ts.handles.trigger")
local Trigger = ____trigger.Trigger
local ____SingletonUtil = require("solar.solar-common.util.lang.SingletonUtil")
local SingletonUtil = ____SingletonUtil.default
local ____DataBase = require("solar.solar-common.common.DataBase")
local DataBase = ____DataBase.default
local ____KeyCode = require("solar.solar-common.constant.KeyCode")
local KeyCode = ____KeyCode.default
local ____SolarConfig = require("solar.solar-common.common.SolarConfig")
local SolarConfig = ____SolarConfig.default
local ____ActorTypeUtil = require("solar.solar-common.actor.util.ActorTypeUtil")
local ActorTypeUtil = ____ActorTypeUtil.default
local ____DebugVmUtil = require("solar.solar-common.util.debug.DebugVmUtil")
local DebugVmUtil = ____DebugVmUtil.default
local ____BaseUtil = require("solar.solar-common.util.BaseUtil")
local BaseUtil = ____BaseUtil.default
local ____ActorUtil = require("solar.solar-common.actor.util.ActorUtil")
local ActorUtil = ____ActorUtil.default
____exports.default = __TS__Class()
local SolarReload = ____exports.default
SolarReload.name = "SolarReload"
function SolarReload.prototype.____constructor(self)
end
function SolarReload.init(self)
    if _G.SolarReloadInitED then
        return
    end
    _G.SolarReloadInitED = true
    if not local_map_dir_path then
        return
    end
    do
        local function ____catch(e)
            print(e)
        end
        local ____try, ____hasReturned = pcall(function()
            log.debug("local_map_dir_path=" .. local_map_dir_path)
            if isEmbedBrowser and _G.webEngine then
                _G.webEngine.path = (((((((((local_map_dir_path .. "webapp\\dist;") .. local_map_dir_path) .. "webapp\\public\\;") .. local_map_dir_path) .. "webapp;") .. local_map_dir_path) .. "frontend;") .. local_map_dir_path) .. "resource;") .. tostring(_G.webEngine.path)
            end
        end)
        if not ____try then
            ____catch(____hasReturned)
        end
    end
    if SolarConfig.reloadMode == "自动全局" then
        ____exports.default:autoReload()
    elseif SolarConfig.reloadMode == "手动" then
        BaseUtil.runLater(
            1,
            function()
                se:on(
                    "_sl_重载脚本",
                    function(data)
                        for loadedKey in pairs(____exports.default.reloadFileConfig) do
                            ____exports.default:reloadFile(loadedKey)
                        end
                    end
                )
                print("当前热加载模式设置为手动！请按F9重加载@SupportReload()装饰的类")
            end
        )
    end
    local jassCreateTrigger = CreateTrigger
    ____exports.default:hookCreators()
    if DzTriggerRegisterKeyEventByCode and not _G.HasTriggerRegisterKeyEvent then
        local t = jassCreateTrigger()
        DzTriggerRegisterKeyEventByCode(
            t,
            KeyCode.VK_F9,
            1,
            true,
            nil
        )
        TriggerAddAction(
            t,
            function()
                if SolarConfig.reloadMode == "自动全局" then
                    ____exports.default:reload()
                end
                se:emit("_sl_重载脚本")
            end
        )
    end
    _G.HasTriggerRegisterKeyEvent = true
    _G.reloadCount = 1
end
function SolarReload.reloadFile(self, fileModName)
    if PACKAGE.loaded[fileModName] == nil then
        print("未初始化:" .. fileModName)
        return
    else
        PACKAGE.loaded[fileModName] = nil
        ____exports.default:destroyFileHandles(fileModName)
    end
    local requireClassResult = require(fileModName)
    local ____opt_result_2
    if requireClassResult ~= nil then
        ____opt_result_2 = requireClassResult.default
    end
    local ____opt_result_2_5 = ____opt_result_2
    if ____opt_result_2_5 then
        local ____opt_3 = ____exports.default.reloadFileConfig[fileModName]
        if ____opt_3 ~= nil then
            ____opt_3 = ____opt_3.autoNew
        end
        ____opt_result_2_5 = ____opt_3 ~= false
    end
    if ____opt_result_2_5 then
        __TS__New(requireClassResult.default)
    end
    _G.reloadCount = _G.reloadCount + 1
    local info = (("No." .. tostring(_G.reloadCount)) .. " [重新加载代码脚本]!") .. tostring(_g_time)
    DisplayTimedTextToPlayer(
        GetLocalPlayer(),
        0,
        0,
        60,
        info
    )
    print(info)
end
function SolarReload.destroyFileHandles(self, fileModName)
    local mapElement = ____exports.default.fileHandlesMap[fileModName]
    if mapElement == nil then
        return
    end
    if mapElement.triggerHandles then
        for ____, handleElement in ipairs(mapElement.triggerHandles) do
            TriggerClearActions(handleElement)
            DisableTrigger(handleElement)
            DestroyTrigger(handleElement)
        end
    end
    if mapElement.timerHandles then
        for ____, handleElement in ipairs(mapElement.timerHandles) do
            DestroyTimer(handleElement)
        end
    end
    if mapElement.unitHandles then
        for ____, handleElement in ipairs(mapElement.unitHandles) do
            RemoveUnit(handleElement)
        end
    end
    if mapElement.itemHandles then
        for ____, handleElement in ipairs(mapElement.itemHandles) do
            RemoveItem(handleElement)
        end
    end
    if mapElement.frameHandles then
        for ____, handleElement in ipairs(mapElement.frameHandles) do
            if handleElement and handleElement > 0 then
                do
                    local function ____catch(e)
                        print((("销毁Frame出错:" .. tostring(handleElement)) .. "=") .. tostring(e))
                    end
                    local ____try, ____hasReturned = pcall(function()
                        DzDestroyFrame(handleElement)
                    end)
                    if not ____try then
                        ____catch(____hasReturned)
                    end
                end
            end
        end
    end
    if mapElement.actors then
        for ____, actor in ipairs(mapElement.actors) do
            if not actor:isDestroyed() then
                actor:destroy(true)
            end
        end
    end
    ____exports.default.fileHandlesMap[fileModName] = {}
end
function SolarReload.hookCreators(self)
    local jassCreateTrigger = CreateTrigger
    _G.CreateTrigger = function()
        local hdl = jassCreateTrigger()
        local ____exports_default_TriggerHandle_6 = ____exports.default.TriggerHandle
        ____exports_default_TriggerHandle_6[#____exports_default_TriggerHandle_6 + 1] = hdl
        local userScripts = DebugVmUtil:getUserScriptRequireModNameByStack()
        for ____, userScript in ipairs(userScripts) do
            if ____exports.default.fileHandlesMap[userScript] == nil then
                ____exports.default.fileHandlesMap[userScript] = {}
            end
            ____exports.default.fileHandlesMap[userScript].triggerHandles = ____exports.default.fileHandlesMap[userScript].triggerHandles or ({})
            local ____exports_default_fileHandlesMap_userScript_triggerHandles_7 = ____exports.default.fileHandlesMap[userScript].triggerHandles
            ____exports_default_fileHandlesMap_userScript_triggerHandles_7[#____exports_default_fileHandlesMap_userScript_triggerHandles_7 + 1] = hdl
        end
        return hdl
    end
    local jassCreateTimer = CreateTimer
    _G.CreateTimer = function()
        local hdl = jassCreateTimer()
        local ____exports_default_TimerHandle_8 = ____exports.default.TimerHandle
        ____exports_default_TimerHandle_8[#____exports_default_TimerHandle_8 + 1] = hdl
        local userScripts = DebugVmUtil:getUserScriptRequireModNameByStack()
        for ____, userScript in ipairs(userScripts) do
            if ____exports.default.fileHandlesMap[userScript] == nil then
                ____exports.default.fileHandlesMap[userScript] = {}
            end
            ____exports.default.fileHandlesMap[userScript].timerHandles = ____exports.default.fileHandlesMap[userScript].timerHandles or ({})
            local ____exports_default_fileHandlesMap_userScript_timerHandles_9 = ____exports.default.fileHandlesMap[userScript].timerHandles
            ____exports_default_fileHandlesMap_userScript_timerHandles_9[#____exports_default_fileHandlesMap_userScript_timerHandles_9 + 1] = hdl
        end
        return hdl
    end
    local jassDzCreateFrameByTagName = DzCreateFrameByTagName
    _G.DzCreateFrameByTagName = function(frameType, name, parent, template, id)
        local hdl = jassDzCreateFrameByTagName(
            frameType,
            name,
            parent,
            template,
            id
        )
        local ____exports_default_frameHandle_10 = ____exports.default.frameHandle
        ____exports_default_frameHandle_10[#____exports_default_frameHandle_10 + 1] = hdl
        local userScripts = DebugVmUtil:getUserScriptRequireModNameByStack()
        for ____, userScript in ipairs(userScripts) do
            if ____exports.default.fileHandlesMap[userScript] == nil then
                ____exports.default.fileHandlesMap[userScript] = {}
            end
            ____exports.default.fileHandlesMap[userScript].frameHandles = ____exports.default.fileHandlesMap[userScript].frameHandles or ({})
            local ____exports_default_fileHandlesMap_userScript_frameHandles_11 = ____exports.default.fileHandlesMap[userScript].frameHandles
            ____exports_default_fileHandlesMap_userScript_frameHandles_11[#____exports_default_fileHandlesMap_userScript_frameHandles_11 + 1] = hdl
        end
        return hdl
    end
    local jassCreateUnit = CreateUnit
    _G.CreateUnit = function(id, unitid, x, y, face)
        local hdl = jassCreateUnit(
            id,
            unitid,
            x,
            y,
            face
        )
        local ____exports_default_unitHandle_12 = ____exports.default.unitHandle
        ____exports_default_unitHandle_12[#____exports_default_unitHandle_12 + 1] = hdl
        local userScripts = DebugVmUtil:getUserScriptRequireModNameByStack()
        for ____, userScript in ipairs(userScripts) do
            if ____exports.default.fileHandlesMap[userScript] == nil then
                ____exports.default.fileHandlesMap[userScript] = {}
            end
            ____exports.default.fileHandlesMap[userScript].unitHandles = ____exports.default.fileHandlesMap[userScript].unitHandles or ({})
            local ____exports_default_fileHandlesMap_userScript_unitHandles_13 = ____exports.default.fileHandlesMap[userScript].unitHandles
            ____exports_default_fileHandlesMap_userScript_unitHandles_13[#____exports_default_fileHandlesMap_userScript_unitHandles_13 + 1] = hdl
        end
        return hdl
    end
    local jassCreateItem = CreateItem
    _G.CreateItem = function(itemid, x, y)
        local hdl = jassCreateItem(itemid, x, y)
        local ____exports_default_itemHandle_14 = ____exports.default.itemHandle
        ____exports_default_itemHandle_14[#____exports_default_itemHandle_14 + 1] = hdl
        local userScripts = DebugVmUtil:getUserScriptRequireModNameByStack()
        for ____, userScript in ipairs(userScripts) do
            if ____exports.default.fileHandlesMap[userScript] == nil then
                ____exports.default.fileHandlesMap[userScript] = {}
            end
            ____exports.default.fileHandlesMap[userScript].itemHandles = ____exports.default.fileHandlesMap[userScript].itemHandles or ({})
            local ____exports_default_fileHandlesMap_userScript_itemHandles_15 = ____exports.default.fileHandlesMap[userScript].itemHandles
            ____exports_default_fileHandlesMap_userScript_itemHandles_15[#____exports_default_fileHandlesMap_userScript_itemHandles_15 + 1] = hdl
        end
        return hdl
    end
    ActorTypeUtil.registerActorType = function(____, actorTypeIdOrActorType)
        local actorType = nil
        if type(actorTypeIdOrActorType) == "string" then
            actorType = {id = actorTypeIdOrActorType}
        else
            actorType = actorTypeIdOrActorType
        end
        if actorType.id == nil or actorType.id.length == 0 then
            print_r(actorType)
            log.errorWithTraceBack("ActorType id必须赋值！")
            return
        end
        DataBase:setSolarActorType(actorType.id, actorType)
        local actorTypes = ActorTypeUtil.actorTypes
        actorTypes[#actorTypes + 1] = actorType
        return actorType
    end
    ActorUtil:addAnyActorCreatedListener(function(____, actor)
        local userScripts = DebugVmUtil:getUserScriptRequireModNameByStack()
        for ____, userScript in ipairs(userScripts) do
            if ____exports.default.fileHandlesMap[userScript] == nil then
                ____exports.default.fileHandlesMap[userScript] = {}
            end
            ____exports.default.fileHandlesMap[userScript].actors = ____exports.default.fileHandlesMap[userScript].actors or ({})
            local ____exports_default_fileHandlesMap_userScript_actors_16 = ____exports.default.fileHandlesMap[userScript].actors
            ____exports_default_fileHandlesMap_userScript_actors_16[#____exports_default_fileHandlesMap_userScript_actors_16 + 1] = actor
        end
    end)
end
function SolarReload.autoReload(self)
    _G.scripts_lastModified = -1
    PACKAGE.loaded._SLA_temp = nil
    do
        pcall(function()
            require("_SLA_temp")
        end)
    end
    _G.scripts_last_reload = _G.scripts_lastModified
    local trigger = __TS__New(Trigger)
    trigger:registerTimerEvent(0.5, true)
    trigger:addAction(function()
        PACKAGE.loaded._SLA_temp = nil
        do
            pcall(function()
                require("_SLA_temp")
            end)
        end
        if _G.scripts_lastModified > _G.scripts_last_reload then
            _G.scripts_last_reload = _G.scripts_lastModified
            if time > 3000 then
                print("======自动更新======")
                print("_G.scripts_lastModified=" .. tostring(_G.scripts_lastModified))
                print("_G.scripts_last_reload=" .. tostring(_G.scripts_last_reload))
                ____exports.default:reload()
            end
        end
    end)
end
function SolarReload.reload(self)
    _G.reloadCount = _G.reloadCount + 1
    local info = (("No." .. tostring(_G.reloadCount)) .. " [重新加载代码脚本]!") .. tostring(_g_time)
    DisplayTimedTextToPlayer(
        GetLocalPlayer(),
        0,
        0,
        60,
        info
    )
    print(info)
    for loadedKey in pairs(PACKAGE.loaded) do
        do
            if loadedKey and (string.find(loadedKey, "solar.", nil, true) or 0) - 1 >= 0 then
                goto __continue82
            end
            PACKAGE.loaded[loadedKey] = nil
        end
        ::__continue82::
    end
    se:clear()
    SingletonUtil.cache:clear()
    SingletonUtil._sl_cache = {}
    DataBase.dataBaseContext = {}
    for ____, handleElement in ipairs(____exports.default.TriggerHandle) do
        TriggerClearActions(handleElement)
        DisableTrigger(handleElement)
        DestroyTrigger(handleElement)
    end
    for ____, handleElement in ipairs(____exports.default.TimerHandle) do
        DestroyTimer(handleElement)
    end
    for ____, handleElement in ipairs(____exports.default.unitHandle) do
        RemoveUnit(handleElement)
    end
    for ____, handleElement in ipairs(____exports.default.itemHandle) do
        RemoveItem(handleElement)
    end
    for ____, handleElement in ipairs(____exports.default.frameHandle) do
        if handleElement and handleElement > 0 then
            do
                local function ____catch(e)
                    print((("销毁Frame出错:" .. tostring(handleElement)) .. "=") .. tostring(e))
                end
                local ____try, ____hasReturned = pcall(function()
                    DzDestroyFrame(handleElement)
                end)
                if not ____try then
                    ____catch(____hasReturned)
                end
            end
        end
    end
    ____exports.default.TriggerHandle = {}
    ____exports.default.TimerHandle = {}
    ____exports.default.frameHandle = {}
    require("App")
end
SolarReload.config = {}
SolarReload.TriggerHandle = {}
SolarReload.TimerHandle = {}
SolarReload.frameHandle = {}
SolarReload.unitHandle = {}
SolarReload.itemHandle = {}
SolarReload.fileHandlesMap = {}
SolarReload.reloadFileConfig = {}
return ____exports
