local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__StringSubstring = ____lualib.__TS__StringSubstring
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["7"] = 2,["8"] = 2,["9"] = 3,["10"] = 3,["11"] = 4,["12"] = 4,["13"] = 10,["14"] = 10,["15"] = 10,["17"] = 10,["18"] = 39,["19"] = 39,["20"] = 39,["22"] = 39,["23"] = 39,["25"] = 40,["26"] = 41,["27"] = 42,["28"] = 43,["29"] = 44,["32"] = 47,["33"] = 48,["34"] = 49,["36"] = 51,["37"] = 39,["38"] = 60,["39"] = 61,["40"] = 62,["41"] = 63,["43"] = 60,["44"] = 73,["45"] = 74,["46"] = 75,["47"] = 73,["48"] = 85,["49"] = 85,["50"] = 85,["52"] = 86,["53"] = 87,["54"] = 88,["55"] = 89,["56"] = 90,["58"] = 92,["59"] = 94,["60"] = 95,["61"] = 96,["62"] = 97,["63"] = 98,["65"] = 100,["66"] = 101,["67"] = 102,["68"] = 103,["70"] = 105,["71"] = 106,["72"] = 107,["73"] = 108,["75"] = 110,["77"] = 85,["78"] = 119,["79"] = 120,["80"] = 121,["81"] = 122,["84"] = 125,["85"] = 126,["87"] = 119,["88"] = 133,["89"] = 134,["90"] = 135,["91"] = 133,["92"] = 142,["93"] = 143,["94"] = 144,["95"] = 145,["98"] = 148,["99"] = 149,["100"] = 150,["102"] = 152,["103"] = 142,["104"] = 158,["105"] = 159,["106"] = 160,["107"] = 161,["109"] = 162,["110"] = 162,["112"] = 163,["113"] = 163,["114"] = 164,["115"] = 165,["116"] = 166,["117"] = 167,["119"] = 163,["122"] = 162,["125"] = 171,["126"] = 171,["127"] = 171,["128"] = 171,["129"] = 171,["130"] = 171,["131"] = 171,["132"] = 172,["133"] = 158,["134"] = 178,["135"] = 179,["136"] = 180,["137"] = 178,["138"] = 186,["139"] = 187,["140"] = 188,["141"] = 189,["142"] = 190,["143"] = 191,["144"] = 192,["145"] = 193,["146"] = 194,["147"] = 195,["149"] = 197,["151"] = 199,["152"] = 186,["153"] = 202,["154"] = 203,["155"] = 204,["156"] = 205,["157"] = 206,["158"] = 207,["160"] = 209,["161"] = 210,["162"] = 211,["163"] = 212,["166"] = 215,["168"] = 219,["169"] = 220,["170"] = 221,["173"] = 224,["174"] = 224,["175"] = 225,["176"] = 226,["177"] = 227,["179"] = 229,["180"] = 230,["181"] = 231,["182"] = 232,["184"] = 234,["186"] = 224,["189"] = 239,["190"] = 240,["191"] = 241,["192"] = 242,["194"] = 244,["197"] = 248,["198"] = 249,["200"] = 202,["201"] = 257,["202"] = 258,["203"] = 259,["204"] = 257,["205"] = 263,["206"] = 264,["207"] = 265,["208"] = 266,["209"] = 267,["211"] = 270,["212"] = 270,["213"] = 270,["214"] = 270,["215"] = 270,["217"] = 272,["218"] = 272,["219"] = 272,["220"] = 272,["221"] = 272,["223"] = 263,["224"] = 283,["225"] = 284,["226"] = 285,["228"] = 287,["229"] = 288,["231"] = 289,["232"] = 289,["233"] = 290,["234"] = 291,["235"] = 292,["236"] = 293,["237"] = 294,["239"] = 289,["242"] = 297,["243"] = 297,["244"] = 297,["245"] = 298,["246"] = 298,["247"] = 298,["248"] = 298,["249"] = 298,["250"] = 298,["251"] = 298,["252"] = 297,["253"] = 297,["254"] = 300,["255"] = 300,["256"] = 300,["257"] = 301,["258"] = 302,["259"] = 302,["260"] = 302,["261"] = 302,["262"] = 302,["263"] = 302,["264"] = 302,["265"] = 300,["266"] = 300,["267"] = 304,["268"] = 304,["269"] = 304,["270"] = 305,["271"] = 306,["272"] = 307,["273"] = 308,["274"] = 308,["275"] = 308,["276"] = 308,["277"] = 308,["278"] = 308,["279"] = 308,["280"] = 304,["281"] = 304,["282"] = 304,["283"] = 311,["284"] = 283,["285"] = 314,["286"] = 315,["287"] = 316,["288"] = 317,["289"] = 318,["290"] = 319,["292"] = 320,["293"] = 320,["295"] = 321,["296"] = 322,["298"] = 323,["299"] = 323,["300"] = 324,["301"] = 325,["302"] = 326,["303"] = 327,["305"] = 330,["306"] = 331,["307"] = 332,["310"] = 323,["313"] = 337,["314"] = 338,["318"] = 368,["319"] = 369,["320"] = 369,["321"] = 369,["322"] = 369,["323"] = 369,["324"] = 369,["325"] = 369,["326"] = 370,["329"] = 342,["330"] = 343,["331"] = 344,["332"] = 345,["333"] = 346,["334"] = 346,["335"] = 346,["336"] = 346,["337"] = 346,["338"] = 346,["339"] = 346,["340"] = 348,["341"] = 348,["342"] = 348,["343"] = 348,["344"] = 348,["345"] = 348,["346"] = 348,["347"] = 350,["350"] = 353,["351"] = 354,["352"] = 356,["353"] = 356,["354"] = 356,["355"] = 356,["356"] = 356,["357"] = 356,["358"] = 356,["359"] = 357,["361"] = 360,["362"] = 361,["363"] = 362,["364"] = 364,["365"] = 365,["372"] = 341,["377"] = 320,["380"] = 373,["381"] = 314,["382"] = 15,["383"] = 16,["384"] = 20,["385"] = 21,["386"] = 23,["387"] = 25,["388"] = 26,["389"] = 27,["390"] = 29,["391"] = 30,["392"] = 281});
local ____exports = {}
local ____CodecUtil = require("solar.solar-common.util.math.CodecUtil")
local CodecUtil = ____CodecUtil.default
local ____DataBase = require("solar.solar-common.common.DataBase")
local DataBase = ____DataBase.default
local ____player = require("solar.solar-common.w3ts.handles.player")
local MapPlayer = ____player.MapPlayer
____exports.default = __TS__Class()
local ArchiveUtil = ____exports.default
ArchiveUtil.name = "ArchiveUtil"
function ArchiveUtil.prototype.____constructor(self)
end
function ArchiveUtil.get(self, whichPlayer, key, limitVal, limitKey)
    if limitVal == nil then
        limitVal = 0
    end
    if limitKey == nil then
        limitKey = ____exports.default.defaultLimitKey
    end
    ____exports.default:_init0()
    if limitVal > 0 then
        local sVal = limitKey and S2I(DzAPI_Map_GetServerValue(whichPlayer, limitKey)) or DzAPI_Map_GetMapLevel(whichPlayer)
        if sVal < limitVal then
            return nil
        end
    end
    local data = ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
    if not data then
        return nil
    end
    return data[key]
end
function ArchiveUtil.updateMaxNumber(self, whichPlayer, key, value)
    local oldVal = ____exports.default:get(whichPlayer, key) or 0
    if value > oldVal then
        ____exports.default:set(whichPlayer, key, oldVal + value)
    end
end
function ArchiveUtil.addNumber(self, whichPlayer, key, addValue)
    local oldVal = ____exports.default:get(whichPlayer, key) or 0
    ____exports.default:set(whichPlayer, key, oldVal + addValue)
end
function ArchiveUtil.set(self, whichPlayer, key, value, isSave)
    if isSave == nil then
        isSave = true
    end
    ____exports.default:_init0()
    local data = ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
    if not data then
        data = {}
        ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))] = data
    end
    data[key] = value
    local bucketId = ____exports.default:_sl_getBucketId(key)
    local playerDataBucket = ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))]
    if playerDataBucket == nil then
        playerDataBucket = {}
        ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))] = playerDataBucket
    end
    local bucket = playerDataBucket[bucketId]
    if bucket == nil then
        bucket = {}
        playerDataBucket[bucketId] = bucket
    end
    bucket[key] = value
    if isSave then
        if isDebug then
            print((("ArchiveUtil.set:" .. key) .. "=") .. tostring(value))
        end
        ____exports.default:_sl_saveBucket(whichPlayer, bucketId, bucket)
    end
end
function ArchiveUtil.saveAll(self, whichPlayer)
    log.errorWithTraceBack("不推荐的用法!一次性保存所有存档容易导致崩溃丢档!")
    local allArchive = ____exports.default:getAllArchive(whichPlayer)
    if allArchive == nil then
        return
    end
    for archiveKey in pairs(allArchive) do
        ____exports.default:set(whichPlayer, archiveKey, allArchive[archiveKey])
    end
end
function ArchiveUtil.getAllArchive(self, whichPlayer)
    ____exports.default:_init0()
    return ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
end
function ArchiveUtil.printAllArchive(self, whichPlayer)
    ____exports.default:_init0()
    local data = ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
    if not data then
        return
    end
    print(("========打印玩家" .. tostring(GetPlayerId(whichPlayer) + 1)) .. "的存档 开始========")
    for dataKey in pairs(data) do
        print(((dataKey .. "=[") .. tostring(data[dataKey])) .. "]")
    end
    print(("========打印玩家" .. tostring(GetPlayerId(whichPlayer) + 1)) .. "的存档 结束========")
end
function ArchiveUtil.clearAllArchive(self, whichPlayer)
    ____exports.default:_init0()
    ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))] = {}
    ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))] = {}
    do
        local bidNo = 0
        while bidNo <= ____exports.default.bucketMax do
            do
                local i = 0
                while i < ____exports.default.ArchiveKeyCountMax do
                    local key = (("B_" .. tostring(bidNo)) .. "_") .. tostring(i)
                    local serverValue = DzAPI_Map_GetServerValue(whichPlayer, key)
                    if serverValue and #serverValue > 0 then
                        DzAPI_Map_FlushStoredMission(whichPlayer, key)
                    end
                    i = i + 1
                end
            end
            bidNo = bidNo + 1
        end
    end
    DisplayTimedTextToPlayer(
        whichPlayer,
        0,
        0,
        10,
        "|cffff0000已清理全部存档!请重开游戏查看效果!"
    )
    print("已清理全部存档!")
end
function ArchiveUtil.getCurrentArchiveKeyMax(self, whichPlayer)
    ____exports.default:_init0()
    return ____exports.default._sl_playerCurrentArchiveKeyMax["P" .. tostring(GetPlayerId(whichPlayer))] or 0
end
function ArchiveUtil.getCurrentArchiveKeyMaxInfo(self, whichPlayer)
    local used = ____exports.default:getCurrentArchiveKeyMax(whichPlayer)
    local p = math.ceil(used * 100 / ____exports.default.ArchiveKeyCountMax)
    local info = ("(" .. tostring(p)) .. "%)"
    if p > 90 then
        info = "|cffff0000" .. info
    elseif p > 80 then
        info = "|cffe24700" .. info
    elseif p > 70 then
        info = "|cffdb7835" .. info
    else
        info = "|cff0a8f17" .. info
    end
    return ((tostring(used) .. "/") .. tostring(____exports.default.ArchiveKeyCountMax)) .. info
end
function ArchiveUtil._sl_saveBucket(self, whichPlayer, bucketId, bucket)
    local dataJsonStr = JSON:stringify(bucket)
    local userIdTag = ____exports.default:_sl_getUserIdTag(whichPlayer)
    dataJsonStr = userIdTag .. __TS__StringSubstring(dataJsonStr, 1, #dataJsonStr - 1)
    if ____exports.default.encrypt then
        dataJsonStr = CodecUtil:saesEncode(dataJsonStr, gameName .. ____exports.default.salt)
    end
    local dataJsonStrLength = #dataJsonStr
    local keyLength = math.floor(dataJsonStrLength / 64) + 1
    if keyLength > ____exports.default.ArchiveKeyCountMax then
        log.errorWithTraceBack((("存档栏位大小超过" .. tostring(____exports.default.ArchiveKeyCountMax)) .. "！") .. tostring(keyLength))
        return
    end
    local oneData = nil
    --- 当存档位需要多个key时  使用批量保存  以保证数据完整性
    local useBatch = false
    if useBatch then
        KKApiBeginBatchSaveArchive(whichPlayer)
    end
    do
        local i = 0
        while i < keyLength do
            local endIndex = (i + 1) * 64
            if endIndex > dataJsonStrLength then
                endIndex = dataJsonStrLength
            end
            oneData = __TS__StringSubstring(dataJsonStr, i * 64, endIndex)
            local key = (bucketId .. "_") .. tostring(i)
            if useBatch then
                KKApiAddBatchSaveArchive(whichPlayer, key, oneData, true)
            else
                DzAPI_Map_SaveServerValue(whichPlayer, key, oneData)
            end
            i = i + 1
        end
    end
    if #oneData == 64 then
        local key = (bucketId .. "_") .. tostring(keyLength)
        if useBatch then
            KKApiAddBatchSaveArchive(whichPlayer, key, "", true)
        else
            DzAPI_Map_FlushStoredMission(whichPlayer, key)
        end
    end
    if useBatch then
        KKApiEndBatchSaveArchive(whichPlayer, true)
    end
end
function ArchiveUtil._sl_getBucketId(self, key)
    local index = math.abs(StringHash(key)) % ____exports.default.bucketMax
    return "B_" .. tostring(index)
end
function ArchiveUtil._sl_getUserIdTag(self, p)
    if GetUserId then
        local uid = MapPlayer:fromHandle(p).userId
        if uid == -1 then
            log.errorWithTraceBack("请等待内置userId(用户id)同步完成！(为了解决玩家名更改后靠userId判断是否是自己的存档)")
        end
        return __TS__StringSubstring(
            CodecUtil:sBase64Encode("SL" .. tostring(uid)),
            0,
            2
        )
    else
        return __TS__StringSubstring(
            CodecUtil:sBase64Encode("SL" .. GetPlayerName(p)),
            0,
            2
        )
    end
end
function ArchiveUtil._init0(self)
    if ____exports.default.isInit then
        return true
    end
    ____exports.default.isInit = true
    ____exports.default._init_time = time
    do
        local i = 0
        while i < bj_MAX_PLAYER_SLOTS do
            local tempPlayer = Player(i)
            if GetPlayerController(tempPlayer) == MAP_CONTROL_USER and GetPlayerSlotState(tempPlayer) == PLAYER_SLOT_STATE_PLAYING then
                local playerAllArchiveData = ____exports.default:_init0_onePlayer(tempPlayer)
                ____exports.default.playerDatas["P" .. tostring(i)] = playerAllArchiveData
                DataBase:getPlayerSolarData(tempPlayer, true)._tt = playerAllArchiveData._tt or 0
            end
            i = i + 1
        end
    end
    se:onPlayerChat(
        "-sl-ia",
        function(e)
            DisplayTimedTextToPlayer(
                e.triggerPlayer,
                0,
                0,
                10,
                ____exports.default:getCurrentArchiveKeyMaxInfo(e.triggerPlayer)
            )
        end
    )
    se:onPlayerChat(
        "-清空存档",
        function(e)
            ____exports.default:clearAllArchive(e.triggerPlayer)
            DisplayTimedTextToPlayer(
                e.triggerPlayer,
                0,
                0,
                10,
                "清空存档完毕!"
            )
        end
    )
    se:onPlayerChat(
        "-sla-remove-",
        function(e)
            local key = __TS__StringSubstring(e.eventPlayerChatString, 12)
            local serverValue = DzAPI_Map_GetServerValue(e.triggerPlayer, key)
            DzAPI_Map_FlushStoredMission(e.triggerPlayer, key)
            DisplayTimedTextToPlayer(
                e.triggerPlayer,
                0,
                0,
                10,
                (("|cffff0000移除存档:" .. key) .. ":") .. tostring(serverValue)
            )
        end,
        false
    )
    return true
end
function ArchiveUtil._init0_onePlayer(self, tempPlayer)
    local data = {}
    local pId = GetPlayerId(tempPlayer)
    local userIdTag = ____exports.default:_sl_getUserIdTag(tempPlayer)
    local buckets = {}
    ____exports.default.playerDataBuckets["P" .. tostring(pId)] = buckets
    do
        local bIndex = 0
        while bIndex < ____exports.default.bucketMax do
            do
                local bucketId = "B_" .. tostring(bIndex)
                local bucketDataJsonStr = ""
                do
                    local i = 0
                    while i < ____exports.default.ArchiveKeyCountMax do
                        local key = (bucketId .. "_") .. tostring(i)
                        local serverValue = DzAPI_Map_GetServerValue(tempPlayer, key)
                        if serverValue and #serverValue > 0 then
                            bucketDataJsonStr = bucketDataJsonStr .. serverValue
                        end
                        if serverValue == nil or #serverValue < 64 then
                            local keyMax = ____exports.default._sl_playerCurrentArchiveKeyMax["P" .. tostring(pId)] or 0
                            ____exports.default._sl_playerCurrentArchiveKeyMax["P" .. tostring(pId)] = keyMax + i
                            break
                        end
                        i = i + 1
                    end
                end
                if #bucketDataJsonStr < 4 then
                    goto __continue60
                end
                do
                    local function ____catch(e)
                        print("存档Json格式解析出错!")
                        DisplayTimedTextToPlayer(
                            GetLocalPlayer(),
                            0,
                            0,
                            60,
                            "存档格式解析出错！请不要私自修改存档数据！"
                        )
                        print(("需要解析的Json字符串为[" .. bucketDataJsonStr) .. "]")
                    end
                    local ____try, ____hasReturned, ____returnValue = pcall(function()
                        if ____exports.default.encrypt then
                            bucketDataJsonStr = CodecUtil:saesDecode(bucketDataJsonStr, gameName .. ____exports.default.salt)
                            if bucketDataJsonStr == nil then
                                print("存档Json格式解析出错!")
                                DisplayTimedTextToPlayer(
                                    GetLocalPlayer(),
                                    0,
                                    0,
                                    60,
                                    ((("|cffff0000玩家" .. tostring(pId + 1)) .. ":") .. GetPlayerName(tempPlayer)) .. " 的存档格式解析出错！"
                                )
                                DisplayTimedTextToPlayer(
                                    tempPlayer,
                                    0,
                                    0,
                                    60,
                                    ("请不要私自修改存档数据或保存存档时终止游戏！" .. "异常的bucketId=") .. bucketId
                                )
                                return true, data
                            end
                        end
                        local bucketUserIdTag = __TS__StringSubstring(bucketDataJsonStr, 0, 2)
                        if ____exports.default.verifyPlayerName and userIdTag ~= bucketUserIdTag then
                            DisplayTimedTextToPlayer(
                                tempPlayer,
                                0,
                                0,
                                20,
                                "|cffff0000存档玩家名验证失败!请重开游戏或使用空存档继续游玩!"
                            )
                            return true, data
                        end
                        bucketDataJsonStr = ("{" .. __TS__StringSubstring(bucketDataJsonStr, 2)) .. "}"
                        local bucketData = JSON:parse(bucketDataJsonStr)
                        buckets[bucketId] = bucketData
                        for bucketDataKey in pairs(bucketData) do
                            data[bucketDataKey] = bucketData[bucketDataKey]
                        end
                    end)
                    if not ____try then
                        ____hasReturned, ____returnValue = ____catch(____hasReturned)
                    end
                    if ____hasReturned then
                        return ____returnValue
                    end
                end
            end
            ::__continue60::
            bIndex = bIndex + 1
        end
    end
    return data
end
ArchiveUtil.encrypt = true
ArchiveUtil.verifyPlayerName = not isDebug
ArchiveUtil.ArchiveKeyCountMax = 120
ArchiveUtil.salt = "s_z_b_s_q_j"
ArchiveUtil.defaultLimitKey = nil
ArchiveUtil.playerDatas = {}
ArchiveUtil._sl_playerCurrentArchiveKeyMax = {}
ArchiveUtil._init_time = -1
ArchiveUtil.playerDataBuckets = {}
ArchiveUtil.bucketMax = 100
ArchiveUtil.isInit = false
return ____exports
